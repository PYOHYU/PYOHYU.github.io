---
title:  "2.2 `Mat` Class"
excerpt: 

categories:
  - Robot
tags:
  - [Vision]

toc: true
toc_sticky: true
 
date: 2022-04-15
last_modified_at: 2022-04-15

use_math: true
published: true
---

<br>

***

### 2.2.1 `Mat` Class 

<br>

`Mat` 클래스는 행렬을 나타낸다. 고차원 행렬도 표현 가능.

<br>

|멤버 변수|설명|
|---|---|
| `Mat::dims` | `Mat` 행렬의 차원. 영상과 같은 2D 행렬의 경우 `2`. |
| `Mat::rows` | 행렬의 행 개수. 영상이 저장되어 있다면 세로 픽셀 크기. 3D 이상의 경우 `-1`. |
| `Mat::cols` | 행렬의 열 개수. 영상이 저장되어 있다면 가로 픽셀 크기. 3D 이상의 경우 `-1`. |
| `Mat::size` | 3차원 이상의 행렬 크기 정보를 참조하는 변수. |
| `Mat::dims` | 행렬의 원소 데이터가 저장된 메모리 공간을 가리키는 포인터형 변수. 빈 행렬의 경우 `NULL`. |

<br>

`Mat` 클래스는 다양한 자료형을 사용 가능. 행렬이 사용하는 자료형을 나타내는 정보를 <span style="color:red">**depth**</span>라고 한다. OpenCV에서 `Mat` 행렬의 depth는 다음 매크로 상수로 표현.

```cpp
CV_<bit-depth>{U|S|F}
```

`<bit-depth>`에는 8, 16, 32, 64의 숫자를 지정할 수 있다. 이는 원소 하나가 차지하는 비트 수. 그 다음으로는 `U`, `S`, `F` 중 하나를 지정 가능하다. `U`는 `unsigned`(부호 없는 정수형), `S`는 `signed`(부호 있는 정수형), `F`는 `float`(부동 소수형)를 의미.

OpenCV 라이브러리는 다음처럼 매크로 상수로 행렬의 depth 표현이 정의되어 있다.

|매크로 상수|나타내는 자료형|
|---|---|
|`#define CV_8U   0`|`uchar`, `unsigned char`|
|`#define CV_8S   1`|`schar`, `signed char`|
|`#define CV_16U  2`|`ushort`, `unsigned short`|
|`#define CV_16S  3`|`signed short`|
|`#define CV_32S  4`|`int`|
|`#define CV_32F  5`|`float`|
|`#define CV_64F  6`|`double`|
|`#define CV_16F  7`|`float16_t`|

<br>

`Mat` 행렬 원소를 구성하는 각각의 값을 <span style="color:red">**channel**</span>이라고 한다. 하나의 행렬을 구성하는 각 channel은 모두 같은 자료형을 사용해야 한다.

그레이스케일 영상은 한 픽셀당 하나의 정보(밝기)만을 사용하므로 1 channel matrix, 트루컬러 영상은 한 픽셀당 세 색상 정보(BGR)를 가지므로 3 channels matrix.

`Mat` 행렬의 depth와 channel 정보를 합쳐서 `Mat` 객체의 <span style="color:red">**type**</span>이라고 부른다. `Mat` 행렬의 type은 다음 매크로 상수로 표현된다.

```cpp
CV_<bit-depth>{U|S|F}C(<number_of_channels>)
```

BGR 컬러 영상은 `unsigned char` 자료형을 사용하고 세 개의 channel을 사용하므로 `CV_8UC3` type.

복소 행렬은 두 실수값을 사용하므로 `CV_32FC2` type.

<br>

***

### 2.2.2 행렬의 생성 및 초기화

<br>

```cpp
// 기본 생성자
Mat img;
---
비어 있는 행렬 생성.
img.rows 와 img.cols 값은 0 이며 img.data 에는 NULL이 저장된다.
```

빈 행렬을 생성했으므로 이를 다른 함수의 입력값으로 쓰거나, 원소 값을 참조하려고 하면 에러가 발생한다.

<br>

생성과 동시에 원소 값을 저장하기 위해 메모리를 할당하고자 한다면 다음 생성자를 사용.

```cpp
// 행, 열, type을 인자로 받는 생성자
Mat::Mat(int rows, int cols, int type);

// 크기와 type을 인자로 받는 생성자
Mat::Mat(Size size, int type);
---
 - rows : 행 개수(영상의 세로 크기)
 - cols : 열 개수(영상의 가로 크기)
 - type : 행렬 타입(매크로 상수)
 - size : 행렬 크기. Size(cols, rows) 또는 Size(width, height)
```

`Size` 클래스는 가로와 세로 순서로 인자를 받는 반면, `Mat` 클래스는 세로와 가로 순서로 인자를 받는다.

```cpp
Mat img2(480, 640, CV_8UC3);  // unsigned char, 3-channels
Mat img3(Size(640, 480), CV_8UC3);
```

<br>

이렇게 행렬을 생성했을 때 문제가 하나 있다. `Mat` 행렬의 모든 값이 쓰레기 값으로 지정되고 만다. `Mat` 객체를 생성함과 동시에 모든 원소 값을 초기화시키고 싶다.

```cpp
// 특정 초기값을 사용해 초기화
Mat::Mat(int rows, int cols, int type, const Scalar& s);
Mat::Mat(Size size, int type, const Scalar& s);
---
 - s : 행렬 원소 초기값
```

초기값으로 사용되는 `s`의 타입은 `Sclar` 클래스. 네 개의 실수 값을 저장할 수 있는 OpenCV 클래스이다. 주로 영상의 픽셀 값을 표현한다. 그레이스케일 영상의 픽셀 값을 표현할 때는 하나의 멤버 변수만을, 3-channels 컬러 영상을 표현할 때는 세 개의 멤버 변수를 사용.

```cpp
Mat img4(480, 640, CV_8UC1, Scalar(128));             // unsigned char, 1-channel greyscale, 128
Mat img5(Size(640, 480), CV_8UC3, Scalar(0, 0, 255)); // unsinged char, 3-channels color, red
```

보통은 행렬을 생성할 때 모든 원소 값을 0으로 초기화한다. 그래서 0으로 초기화된 행렬을 생성해주는 함수를 별도로 만들어 두었다. `Mat::zero()`라는 함수이다.

```cpp
static MatExpr Mat::zeros(int rows, int cols, int type);
static MatExpr Mat::zeros(Size size, int type);
---
- return : 모든 원소가 0으로 초기화된 행렬 표현식
```

주의할 점은 `Mat::zero()` 함수는 정적 멤버 함수이므로 `Mat::`를 붙여서 사용해야 한다. 반환 타입인 `MatExpr`은 행렬의 대수 연산을 표현하는 클래스. 자동으로 `Mat` 클래스로 변환된다.

```cpp
Mat mat1 = Mat::zeros(3, 3, CV_32SC1);  // int, 1-channel, 3 x 3 zero matrix 
```

마찬가지로 모든 원소가 1로 초기화된 행렬, 단위 행렬을 생성하는 함수도 존재.

```cpp
static MatExpr Mat::ones(int rows, int cols, int type);
static MatExpr Mat::ones(Size size, int type);
---
- return : 모든 원소가 1로 초기화된 행렬 표현식
```
```cpp
static MatExpr Mat::eye(int rows, int cols, int type);
static MatExpr Mat::eye(Size size, int type);
---
- return : 단위 행렬 표현식
```

<br>

`Mat` 행렬 생성 시 새로 메모리 공간을 할당하지 않고 이미 할당된 메모리 공간의 데이터를 행렬의 값으로 사용할 수 있다. 외부 메모리를 참조하므로 행렬 생성이 빨라진다.

```cpp
// 기존 메모리 공간을 참조하여 생성
Mat::Mat(int rows, int cols, int type, void* data, size_t step=AUTO_STEP);
Mat::Mat(Size size, int type, void* data, size_t step=AUTO_STEP);
---
 - data : 사용할 외부 행렬 데이터 주소.
 - step : 외부 행렬 데이터에서 한 행이 차지하는 byte 수. 외부 행렬 데이터의 각 행에 여분의 padding byte가 있으면 명시적으로 지정할 필요가 있다. 기본값 AUTO_STEP은 padding byte가 없다고 가정.
```

만일 다음 `float`형 array를 먼저 정의하고 이 배열을 행렬 원소로 사용하는 `Mat` 객체를 생성하고자 한다면,

```cpp
float data[] = { 1,2,3,4,5,6 };
Mat mat2(2, 3, CV_32FC1, data);
```

이렇게 외부 배열 크기와 생성할 행렬 원소의 수가 같아야 하고, 사용되는 자료형도 같아야 한다. 이렇게 생성된 `mat2` 행렬은 다음 형태.

$$
\textrm{mat2}=
\begin{bmatrix}
1 & 2 & 3 \\
4 & 5 & 6
\end{bmatrix}
$$

외부 메모리 공간을 참조해 `Mat` 객체를 생성할 경우, `Mat` 객체의 원소 값과 외부 메모리 공간의 데이터 값은 서로 연동된다. 외부 메모리 값을 변경하면 `mat2`의 원소 값도 변경되고 그 반대도 마찬가지이다.

<br>

`Mat_`클래스를 사용하는 방법도 있다. `Mat_` 클래스는 `Mat` 클래스를 상속해서 만든 template class이며 두 클래스는 상호 변환이 가능.

`Mat_` 클래스에서는 `<<` 연산자와 `,`를 이용해 간단히 행렬 원소값을 설정할 수 있다.

```cpp
Mat_<float> mat3_(2, 3);
mat3_ << 1, 2, 3, 4, 5, 6;
Mat mat3 = mat3_;
```

위 예시는 먼저 `Mat_` 객체를 생성. Template class이므로 저장할 원소의 자료형을 명시하고 `rows`와 `cols`를 사용해 객체를 생성했다. 그 다음으로 `<<` 연산자와 `,`를 이용해 `mat3_` 행렬의 전체 여섯 원소 값을 순서대로 지정. 마지막 line에서 `mat3_` 행렬을 복사하여 `Mat` 클래스 타입의 객체 `mat3`를 선언.

이렇게 만들어진 `mat3` 행렬은 $2 \times 3$의 크기를 갖고, 타입은 `CV_32FC1`이며 `mat3_` 행렬과 같은 원소를 공유한다. 이를 한 줄로 나타내면,

```cpp
Mat mat4 = (Mat_<float>(2, 3) << 1, 2, 3, 4, 5, 6);
Mat mat5 = Mat_<float>({2, 3}, { 1, 2, 3, 4, 5, 6 }); // 초기화 리스트 사용
```

<br>

비어 있는 `Mat` 객체 또는 이미 생성된 `Mat` 객체에 새로운 행렬을 할당하는 멤버 함수는 `Mat::create()`이다.

```cpp
// 이미 생성된 객체에 새 행렬 할당
void Mat::create(int rows, int cols, int type);
void Mat::create(Size size, int type);
```

만약 `Mat::create()` 함수의 인자로 지정한 행렬 크기와 타입이 기존 행렬과 다르면, `Mat::create()` 함수는 기존 메모리 공간을 해제하고 새로운 메모리 공간을 할당한다.

`Mat::create()` 함수는 새로 만든 행렬의 원소 값을 초기화하는 기능이 없다. 이때는 `=` 연산자 재정의 또는 `Mat::setTo()' 멤버 함수를 이용한다.

```cpp
Mat& Mat::operator = (const Scalar& s);
---
- s : 원소에 설정할 값
- return : 값이 설정된 Mat 객체의 참조
```

```cpp
Mat& Mat::setTo(InputArray value, InputArray mask = noArray());
---
 - value : 원소에 설정할 값
 - mask : 마스크 행렬. 마스크 행렬의 원소가 0이 아닌 위치에서만 value 값이 설정된다. 행렬 전체 원소 값을 설정하려면 noArray() 또는 Mat()를 지정.(생략 가능)
 - return : Mat 객체의 참조
```

이를 이용해 `mat5`의 모든 원소 값을 일괄적으로 설정하면,

```cpp
mat5.setTo(1.f);  // 모든 원소 값이 1.f로 설정
```